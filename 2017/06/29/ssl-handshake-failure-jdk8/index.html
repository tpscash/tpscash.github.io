<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> SSL Handshake Failure after Upgrading to JDK 8 · TPS Cash Team Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="SSL Handshake Failure after Upgrading to JDK 8 - Kevin"><meta name="keywords"><meta name="author" content="Kevin"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://tpscash.github.io/atom.xml" title="TPS Cash Team Blog"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="POSTS" class="nav-list-link">POSTS</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="ARCHIVES" class="nav-list-link">ARCHIVES</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">SSL Handshake Failure after Upgrading to JDK 8</h1><div class="post-info">2017-06-29<p class="visit"><i data-hk-page="current">- </i><span> Views</span></p></div><div class="post-content"><p>This post is for tracking the process to solve a SSL issue after JDK 8 upgrade.</p>
<a id="more"></a>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>We have a component which is using PKCS12 key store as the SSL identify when connecting to an external EMS instance, code like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;bean name=&quot;jndiTemplate&quot; class=&quot;org.springframework.jndi.JndiTemplate&quot;&gt;</div><div class="line">   &lt;property name=&quot;environment&quot;&gt;</div><div class="line">       &lt;props&gt;</div><div class="line">           &lt;prop key=&quot;java.naming.factory.initial&quot;&gt;com.tibco.tibjms.naming.TibjmsInitialContextFactory&lt;/prop&gt;</div><div class="line">           &lt;prop key=&quot;java.naming.provider.url&quot;&gt;$&#123;ems_ssl_url&#125;&lt;/prop&gt;</div><div class="line">           &lt;prop key=&quot;com.tibco.tibjms.naming.ssl_identity&quot;&gt;$&#123;path_to_the_p12_file&#125;&lt;/prop&gt;</div><div class="line">           &lt;prop key=&quot;com.tibco.tibjms.naming.ssl_password&quot;&gt;$&#123;ssl_password&#125;&lt;/prop&gt;</div><div class="line">           &lt;prop key=&quot;com.tibco.tibjms.naming.security_protocol&quot;&gt;ssl&lt;/prop&gt;</div><div class="line">           &lt;!--&lt;prop key=&quot;com.tibco.tibjms.naming.ssl_cipher_suites&quot;&gt;RC4-MD5&lt;/prop&gt;--&gt;</div><div class="line">           &lt;prop key=&quot;com.tibco.tibjms.naming.ssl_enable_verify_host&quot;&gt;false&lt;/prop&gt;</div><div class="line">           &lt;prop key=&quot;com.tibco.tibjms.naming.ssl_enable_verify_hostname&quot;&gt;false&lt;/prop&gt;</div><div class="line">      &lt;/props&gt;</div><div class="line">   &lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<p>This EMS connection stopped working after we upgraded to JDK 8, error in the log:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">javax.jms.JMSSecurityException: Failed to connect to any server at: ssl://xxxx [Error: Failed to connect via SSL to [ssl://xxxx]: Received fatal alert: handshake_failure: url that returned this exception = SSL://xxxx ]</div></pre></td></tr></table></figure>
<h2 id="Solving-the-Issue"><a href="#Solving-the-Issue" class="headerlink" title="Solving the Issue"></a>Solving the Issue</h2><h3 id="Get-More-Intel"><a href="#Get-More-Intel" class="headerlink" title="Get More Intel"></a>Get More Intel</h3><p>It was handshake failure while building the SSL connection, so I enabled debugging on the SSL connection by -Djavax.net.debug=ssl and it gave me:</p>
<p>*** ClientHello, TLSv1</p>
<p>RandomCookie:  GMT: 1498746256 bytes = { 236, 170, 65, 179, 185, 201, 110, 99, 17, 112, 13, 59, 2, 67, 217, 159, 2, 1, 83, 70, 37, 196, 220, 130, 16, 124, 243, 89 }</p>
<p>Session ID:  {}</p>
<p>Cipher Suites: [TLS_RSA_WITH_AES_128_CBC_SHA, SSL_RSA_WITH_3DES_EDE_CBC_SHA, SSL_DHE_DSS_WITH_3DES_EDE_CBC_SHA, SSL_RSA_WITH_DES_CBC_SHA, SSL_DHE_DSS_WITH_DES_CBC_SHA, SSL_DHE_DSS_EXPORT_WITH_DES40_CBC_SHA, TLS_DHE_RSA_WITH_AES_128_CBC_SHA, TLS_DHE_DSS_WITH_AES_128_CBC_SHA, SSL_RSA_WITH_NULL_MD5, SSL_RSA_WITH_NULL_SHA]</p>
<p>Compression Methods:  { 0 }</p>
<p>Extension server_name, server_name: [type=host_name (0), value=xxxx]</p>
<p>Extension renegotiation_info, renegotiated_connection: <empty></empty></p>
<p>***</p>
<p>main, WRITE: TLSv1 Handshake, length = 105</p>
<p>main, READ: TLSv1 Alert, length = 2</p>
<p>main, RECV TLSv1.2 ALERT:  fatal, handshake_failure</p>
<h3 id="Possible-Reasons"><a href="#Possible-Reasons" class="headerlink" title="Possible Reasons"></a>Possible Reasons</h3><p>The handshake failure could have occurred due to various reasons:</p>
<ul>
<li><p>Incompatible cipher suites in use by the client and the server. This would require the client to use (or enable) a cipher suite that is supported by the server.</p>
</li>
<li><p>Incompatible versions of SSL in use (the server might accept only TLS v1, while the client is capable of only using SSL v3). Again, the client might have to ensure that it uses a compatible version of the SSL/TLS protocol.</p>
</li>
<li><p>Incomplete trust path for the server certificate; the server’s certificate is probably not trusted by the client. This would usually result in a more verbose error, but it is quite possible. Usually the fix is to import the server’s CA certificate into the client’s trust store.</p>
</li>
<li><p>The certificate is issued for a different domain. Again, this would have resulted in a more verbose message, but I’ll state the fix here in case this is the cause. The resolution in this case would be get the server (it does not appear to be yours) to use the correct certificate</p>
</li>
</ul>
<h3 id="Suspect-and-Experiment"><a href="#Suspect-and-Experiment" class="headerlink" title="Suspect and Experiment"></a>Suspect and Experiment</h3><p>I doubt this is very likely the cipher issue as I encountered before, so I tested the remote EMS server by:</p>
<p>openssl s_client -tls1 -connect xxxx</p>
<p>The test returned successfully but I saw below from the output:</p>
<p>New, TLSv1/SSLv3, Cipher is RC4-MD5<br>Server public key is 2048 bit<br>Secure Renegotiation IS supported<br>Compression: NONE<br>Expansion: NONE<br>SSL-Session:<br>    Protocol  : TLSv1<br>    Cipher    : RC4-MD5</p>
<h3 id="Research-and-Confirm"><a href="#Research-and-Confirm" class="headerlink" title="Research and Confirm"></a>Research and Confirm</h3><p>The EMS server is using RC4 ciphers, after google it, no surprise that RC4 had been disabled since JDK 8u51 update:</p>
<p><a href="http://www.oracle.com/technetwork/java/javase/8u51-relnotes-2587590.html" target="_blank" rel="external">Java™ SE Development Kit 8, Update 51 Release Notes</a> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">RC4 is now considered as a weak cipher. Servers should not select RC4 unless there is no other stronger candidate in the client requested cipher suites. A new security property, jdk.tls.legacyAlgorithms, is added to define the legacy algorithms in Oracle JSSE implementation. RC4 related algorithms are added to the legacy algorithms list.</div><div class="line"> </div><div class="line"> </div><div class="line">JDK-8043201 (not public)</div><div class="line"> </div><div class="line"> </div><div class="line">Area: security-libs/javax.net.ssl</div><div class="line">Synopsis: Prohibit RC4 cipher suites</div><div class="line"> </div><div class="line"> </div><div class="line">RC4 is now considered as a compromised cipher. RC4 cipher suites have been removed from both client and server default enabled cipher suite list in Oracle JSSE implementation. These cipher suites can still be enabled by SSLEngine.setEnabledCipherSuites() and SSLSocket.setEnabledCipherSuites() methods</div></pre></td></tr></table></figure>
<h3 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h3><p>It is possible that to enable RC4 again by removing RC4 from JDK disabled algorithms list defined in $JAVA_HOME/jre/lib/security/java.security file or pragmatically enabling them using </p>
<p>Security.setProperty(“jdk.tls.disabledAlgorithms”, “” /*disabledAlgorithms*/ );</p>
<p>But by Security.setProperty(), it is not reliable because the fields which hold disabled algorithms are static and final, So if that class gets loaded first you don’t have control over it, you could alternatively try by creating a properties file like this</p>
<p>## override it to remove RC4, in disabledcipher.properties</p>
<p>jdk.tls.disabledAlgorithms=DHE</p>
<p>and in your JVM, you could refer it as system property like this</p>
<p>java -Djava.security.properties=[path_to_the_disabledcipher.properties_file]</p>
<p>However better solution would be to update the EMS server configuration to upgrade to stronger Ciphers, but since the EMS instance is not owned by us, so we have to go hack it this way.</p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>Categories</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/TED/">TED</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">framework</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/home/">home</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/technologies/">technologies</a><span class="category-list-count">48</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>Tag Cloud </h4><a href="/tags/Mac/" style="font-size: 12px;">Mac</a> <a href="/tags/TED/" style="font-size: 10px;">TED</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/annotation/" style="font-size: 10px;">annotation</a> <a href="/tags/api/" style="font-size: 10px;">api</a> <a href="/tags/centos/" style="font-size: 14px;">centos</a> <a href="/tags/cucumber/" style="font-size: 10px;">cucumber</a> <a href="/tags/curl/" style="font-size: 10px;">curl</a> <a href="/tags/database/" style="font-size: 12px;">database</a> <a href="/tags/design/" style="font-size: 10px;">design</a> <a href="/tags/docker/" style="font-size: 12px;">docker</a> <a href="/tags/git/" style="font-size: 18px;">git</a> <a href="/tags/home/" style="font-size: 10px;">home</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jdk/" style="font-size: 14px;">jdk</a> <a href="/tags/jekyll/" style="font-size: 10px;">jekyll</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/life/" style="font-size: 14px;">life</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/lunr/" style="font-size: 10px;">lunr</a> <a href="/tags/mail/" style="font-size: 10px;">mail</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/mysql/" style="font-size: 12px;">mysql</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/nosql/" style="font-size: 10px;">nosql</a> <a href="/tags/oracle/" style="font-size: 12px;">oracle</a> <a href="/tags/outing/" style="font-size: 10px;">outing</a> <a href="/tags/principles/" style="font-size: 10px;">principles</a> <a href="/tags/project/" style="font-size: 10px;">project</a> <a href="/tags/recipe/" style="font-size: 10px;">recipe</a> <a href="/tags/regex/" style="font-size: 14px;">regex</a> <a href="/tags/restful/" style="font-size: 10px;">restful</a> <a href="/tags/sed/" style="font-size: 10px;">sed</a> <a href="/tags/servlet/" style="font-size: 10px;">servlet</a> <a href="/tags/shell/" style="font-size: 16px;">shell</a> <a href="/tags/sql/" style="font-size: 12px;">sql</a> <a href="/tags/ss/" style="font-size: 10px;">ss</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a></div></div><div class="widget"><div class="recent"><h4>Recent Posts </h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/25/maven-docker-plugin/">Build Docker Image with Maven</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/23/shuangxi-outing/">Shuangxi Outing</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/ssl-handshake-failure-jdk8/">SSL Handshake Failure after Upgrading to JDK 8</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/check-connection-count/">Check DB Connection Count for Processes on Linux</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/23/discover-the-mystery-of-metaspace/">Discover the Mystery of Metaspace</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2017/07/23/shuangxi-outing/" class="prev">PREV</a><a href="/2017/06/29/check-connection-count/" class="next">NEXT</a></div><div id="disqus_thread"><script type="text/javascript">
var disqus_shortname = 'tpscash';
var disqus_identifier = '2017/06/29/ssl-handshake-failure-jdk8/';
var disqus_title = 'SSL Handshake Failure after Upgrading to JDK 8';
var disqus_url = 'http://tpscash.github.io/2017/06/29/ssl-handshake-failure-jdk8/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div><div class="copyright"><p>© 2016 - 2017 <a target="_blank">Kevin</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p>闽ICP备16007301号-2</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>