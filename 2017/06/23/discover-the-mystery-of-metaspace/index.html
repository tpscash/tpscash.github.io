<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Discover the Mystery of Metaspace · TPS Cash Team Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Discover the Mystery of Metaspace - Kevin"><meta name="keywords"><meta name="author" content="Kevin"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://tpscash.github.io/atom.xml" title="TPS Cash Team Blog"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="POSTS" class="nav-list-link">POSTS</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="ARCHIVES" class="nav-list-link">ARCHIVES</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Discover the Mystery of Metaspace</h1><div class="post-info">2017-06-23<p class="visit"><i data-hk-page="current">- </i><span> Views</span></p></div><div class="post-content"><p>The JDK 8 HotSpot JVM is now using native memory for the representation of class metadata and is called Metaspace</p>
<a id="more"></a>
<h2 id="What-is-Metaspace"><a href="#What-is-Metaspace" class="headerlink" title="What is Metaspace"></a>What is Metaspace</h2><p>Metaspace is nothing but a replacement of our old friend PermGen (Permanent Generation) space. The main difference between PermGen and Metaspace is that Metaspace by default auto increases its size while PermGen always has a fixed maximum size. You can set a fixed maximum for Metaspace with JVM parameters, but you can’t make PermGen auto increase. By default class metadata allocation is limited by the amount of available native memory (capacity will of course depend if you use a 32-bit JVM vs. 64-bit along with OS virtual memory availability). The main purpose of Metaspace is to reduce the OOM error caused by PermGen is exhausted (although the removal of PermGen doesn’t mean that your class loader leak issues are gone).</p>
<h2 id="What-is-Metaspace-Composed-of"><a href="#What-is-Metaspace-Composed-of" class="headerlink" title="What is Metaspace Composed of"></a>What is Metaspace Composed of</h2><p>If <code>UseCompressedOops</code> is turned on and <code>UseCompressedClassesPointers</code> is used, then two logically different areas of native memory are used for class metadata - <code>Klass Metaspace</code> &amp; <code>NoKlass Metaspace</code>. UseCompressedClassPointers uses a 32-bit offset to represent the class pointer in a 64-bit process as does UseCompressedOops for Java object references. A region (Klass Metaspace) is allocated for these compressed class pointers (the 32-bit offsets). The size of the region can be set with <code>CompressedClassSpaceSize</code> and is 1 gigabyte (GB) by default and it is just adjacent to the heap. The space for the compressed class pointers is reserved as space allocated by <code>mmap</code> at initialization and committed as needed. The <code>MaxMetaspaceSize</code> applies to the sum of the committed compressed class space and the space for the other class metadata (NoKlass Metaspace). If UseCompressedOops &amp; UseCompressedClassesPointers are turned off or <code>-Xmx</code> is set to greater than 32G, the Klass Metaspace will not exist, all Klass will be nested in NoKlass Metaspace in this case.</p>
<p>Java Hotspot VM explicitly manages the space used for metadata. Space is requested from the OS and then divided into chunks (can be discontiguous chunks). A class loader allocates space for metadata from its chunks (a chunk is bound to a specific class loader). When classes are unloaded for a class loader, its chunks are recycled for reuse or returned to the OS. Metadata uses space allocated by <code>mmap</code>, not by <code>malloc</code>. Klass Metaspace &amp; NoKlass Metaspace are shared by all class loaders.</p>
<h2 id="Metaspace-Tuning"><a href="#Metaspace-Tuning" class="headerlink" title="Metaspace Tuning"></a>Metaspace Tuning</h2><p>Class metadata is deallocated when the corresponding Java class is unloaded. Java classes are unloaded as a result of garbage collection, and garbage collections may be induced in order to unload classes and deallocate class metadata. When the space committed for class metadata reaches a certain level (a high-water mark), a garbage collection is induced. After the garbage collection, the high-water mark may be raised or lowered depending on the amount of space freed from class metadata. The high-water mark would be raised so as not to induce another garbage collection too soon. The high-water mark is <strong>initially</strong> set to the value of the command-line option <code>MetaspaceSize</code>. <strong>It is raised or lowered based on the options MaxMetaspaceFreeRatio and MinMetaspaceFreeRatio</strong>. If the committed space available for class metadata as a percentage of the total committed space for class metadata is greater than <code>MaxMetaspaceFreeRatio</code>, then the high-water mark will be lowered. If it is less than <code>MinMetaspaceFreeRatio</code>, then the high-water mark will be raised</p>
<p>Specify a higher value for the option <code>MetaspaceSize</code> to avoid early garbage collections induced for class metadata. The amount of class metadata allocated for an application is application-dependent and general guidelines do not exist for the selection of MetaspaceSize. The default size of MetaspaceSize is platform-dependent and ranges from 12 MB to about 20 MB.</p>
<p>Besides all the parameters mentioned above, there are also several other parameters to change Metaspace behaviors, below list includes them all together:</p>
<ul>
<li>UseLargePagesInMetaspace</li>
<li>InitialBootClassLoaderMetaspace</li>
<li>MetaspaceSize</li>
<li>MaxMetaSpaceSize</li>
<li>CompressClassSpaceSize</li>
<li>MinMetaspaceExpansion</li>
<li>MaxMetaspaceExpansion</li>
<li>MinMetaspaceFreeRatio</li>
<li>MaxMetaspaceFreeRatio</li>
</ul>
<h3 id="UseLargePagesInMetaspace"><a href="#UseLargePagesInMetaspace" class="headerlink" title="UseLargePagesInMetaspace"></a>UseLargePagesInMetaspace</h3><p>By default its value is false. This parameter specify if use LargePage in Metaspace. Generally the page size is 4KB. This parameter takes effect only if <code>UseLargePages</code> is turned on, but usually it is turned off.</p>
<h3 id="InitialBootClassLoaderMetaspaceSize"><a href="#InitialBootClassLoaderMetaspaceSize" class="headerlink" title="InitialBootClassLoaderMetaspaceSize"></a>InitialBootClassLoaderMetaspaceSize</h3><p>By default its value is 4M in 64-bit JVM and 2200K in 32-bit JVM. This parameter indicates the size of the first block of NoKlass Metaspace - 2 * InitialBootClassLoaderMetaspaceSize, meanwhile it indicates the size of the first chunk of bootstrapClassLoader.</p>
<h3 id="MetaspaceSize"><a href="#MetaspaceSize" class="headerlink" title="MetaspaceSize"></a>MetaspaceSize</h3><p>By default its value is about 20M (~20.8M). It is the initial threshold (also the minimum threshold) of Metaspace GC.</p>
<h3 id="MaxMetaspaceSize"><a href="#MaxMetaspaceSize" class="headerlink" title="MaxMetaspaceSize"></a>MaxMetaspaceSize</h3><p>By default it’s unlimited. It is recommended to set value for this parameter to avoid memory leak exhausted all the OS memory.</p>
<h3 id="CompressedClassSpaceSize"><a href="#CompressedClassSpaceSize" class="headerlink" title="CompressedClassSpaceSize"></a>CompressedClassSpaceSize</h3><p>By default its value is 1g. It is the size of Klass Metaspace. It only takes effect when <code>UseCompressedOops</code> &amp; <code>UseCompressedClassesPointers</code> are turned on and <code>-Xmx</code> doesn’t exceed 32G</p>
<h3 id="MinMetaspaceExpansion"><a href="#MinMetaspaceExpansion" class="headerlink" title="MinMetaspaceExpansion"></a>MinMetaspaceExpansion</h3><p>Is it the minimum size to expand when Metaspace is not enough (as its name implies)? No…</p>
<p>It is the minimum requirement on the incremental size when increasing the threshold of Metaspace GC. By default its value is 332.8K.</p>
<h3 id="MaxMetaspaceExpansion"><a href="#MaxMetaspaceExpansion" class="headerlink" title="MaxMetaspaceExpansion"></a>MaxMetaspaceExpansion</h3><p>By default its value is 5.2M. It is the maximum requirement on the incremental size when increasing the threshold of Metaspace GC. If the incremental size exceeds MinMetaspaceExpansion but less than MaxMetaspaceExpansion, then the incremental size is MaxMetaspaceExpansion. If the incremental size exceeds MaxMetaspaceExpansion, then the incremental size is MinMetaspaceExpansion + original incremental size</p>
<h3 id="MinMetaspaceFreeRatio"><a href="#MinMetaspaceFreeRatio" class="headerlink" title="MinMetaspaceFreeRatio"></a>MinMetaspaceFreeRatio</h3><p>By default its value is 40. After a GC activity, If the committed space available for class metadata as a percentage of the total committed space for class metadata is less than MinMetaspaceFreeRatio, then the threshold of Metaspace GC will be raised, but the incremental size of the threshold must meets the requirement by MinMetaspaceExpansion, otherwise the threshold will not be raised.</p>
<h3 id="MaxMetaspaceFreeRatio"><a href="#MaxMetaspaceFreeRatio" class="headerlink" title="MaxMetaspaceFreeRatio"></a>MaxMetaspaceFreeRatio</h3><p>By default its value n 70. The effect of this parameter is the opposite to the MinMetaspaceFreeRatio.</p>
<h2 id="Tools-to-Check-Metaspace"><a href="#Tools-to-Check-Metaspace" class="headerlink" title="Tools to Check Metaspace"></a>Tools to Check Metaspace</h2><p>We can use <code>jstat</code> to check the Metaspace of a JVM process:</p>
<p><code>jstat -gc &lt;pid&gt;</code></p>
<p>Meaning of the output:</p>
<h3 id="MC"><a href="#MC" class="headerlink" title="MC"></a>MC</h3><p>It is total committed size of Klass Metaspace &amp; NoKlass Metaspace (it is committed size although the name is interpreted to capacity). Unit is KB.</p>
<h3 id="MU"><a href="#MU" class="headerlink" title="MU"></a>MU</h3><p>It is used size of Klass Metaspace &amp; NoKlass Metaspace. Unit is KB.</p>
<h3 id="CCSC"><a href="#CCSC" class="headerlink" title="CCSC"></a>CCSC</h3><p>It is the committed size of Klass Metaspace. Unit is KB.</p>
<h3 id="CCSU"><a href="#CCSU" class="headerlink" title="CCSU"></a>CCSU</h3><p>It is the used size of Klass Metaspace.</p>
<h3 id="M"><a href="#M" class="headerlink" title="M"></a>M</h3><p>It is the total usage of Klass Metaspace &amp; NoKlass Metaspace - (CCSU + MU) / (CCSC + MC).</p>
<h3 id="CCS"><a href="#CCS" class="headerlink" title="CCS"></a>CCS</h3><p>It is the usage of NoKlass Metaspace - CCSU / CCSC.</p>
<h3 id="MCMX"><a href="#MCMX" class="headerlink" title="MCMX"></a>MCMX</h3><p>It is total reserved size of Klass Metaspace &amp; NoKlass Metaspace. By default, Klass Metaspace reserves 1g of memory and NoKlass Metaspace reserves 2 * InitialClassLoaderMetaspaceSize of memory.</p>
<h3 id="CCSMX"><a href="#CCSMX" class="headerlink" title="CCSMX"></a>CCSMX</h3><p>It is the reserved size of Klass Metaspace.</p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>Categories</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/TED/">TED</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">framework</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/home/">home</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/technologies/">technologies</a><span class="category-list-count">47</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>Tag Cloud </h4><a href="/tags/Mac/" style="font-size: 12px;">Mac</a> <a href="/tags/TED/" style="font-size: 10px;">TED</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/annotation/" style="font-size: 10px;">annotation</a> <a href="/tags/api/" style="font-size: 10px;">api</a> <a href="/tags/centos/" style="font-size: 14px;">centos</a> <a href="/tags/cucumber/" style="font-size: 10px;">cucumber</a> <a href="/tags/curl/" style="font-size: 10px;">curl</a> <a href="/tags/database/" style="font-size: 12px;">database</a> <a href="/tags/design/" style="font-size: 10px;">design</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/git/" style="font-size: 18px;">git</a> <a href="/tags/home/" style="font-size: 10px;">home</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jdk/" style="font-size: 14px;">jdk</a> <a href="/tags/jekyll/" style="font-size: 10px;">jekyll</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/life/" style="font-size: 14px;">life</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/lunr/" style="font-size: 10px;">lunr</a> <a href="/tags/mail/" style="font-size: 10px;">mail</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/mysql/" style="font-size: 12px;">mysql</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/nosql/" style="font-size: 10px;">nosql</a> <a href="/tags/oracle/" style="font-size: 12px;">oracle</a> <a href="/tags/outing/" style="font-size: 10px;">outing</a> <a href="/tags/principles/" style="font-size: 10px;">principles</a> <a href="/tags/project/" style="font-size: 10px;">project</a> <a href="/tags/recipe/" style="font-size: 10px;">recipe</a> <a href="/tags/regex/" style="font-size: 14px;">regex</a> <a href="/tags/restful/" style="font-size: 10px;">restful</a> <a href="/tags/sed/" style="font-size: 10px;">sed</a> <a href="/tags/servlet/" style="font-size: 10px;">servlet</a> <a href="/tags/shell/" style="font-size: 16px;">shell</a> <a href="/tags/sql/" style="font-size: 12px;">sql</a> <a href="/tags/ss/" style="font-size: 10px;">ss</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a></div></div><div class="widget"><div class="recent"><h4>Recent Posts </h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/07/23/shuangxi-outing/">Shuangxi Outing</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/check-connection-count/">Check DB Connection Count for Processes on Linux</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/ssl-handshake-failure-jdk8/">SSL Handshake Failure after Upgrading to JDK 8</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/23/discover-the-mystery-of-metaspace/">Discover the Mystery of Metaspace</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/16/entrypoint-vs-cmd/">ENTRYPOINT vs. CMD in Dockerfile</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2017/06/29/ssl-handshake-failure-jdk8/" class="prev">PREV</a><a href="/2017/04/16/entrypoint-vs-cmd/" class="next">NEXT</a></div><div id="disqus_thread"><script type="text/javascript">
var disqus_shortname = 'tpscash';
var disqus_identifier = '2017/06/23/discover-the-mystery-of-metaspace/';
var disqus_title = 'Discover the Mystery of Metaspace';
var disqus_url = 'http://tpscash.github.io/2017/06/23/discover-the-mystery-of-metaspace/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div><div class="copyright"><p>© 2016 - 2017 <a target="_blank">Kevin</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p>闽ICP备16007301号-2</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>