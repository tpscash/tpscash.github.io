<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Wiremock - A fallback solution for existing API? · TPS Cash Team Blog</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Wiremock - A fallback solution for existing API? - Kevin"><meta name="keywords"><meta name="author" content="Kevin"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://tpscash.github.io/atom.xml" title="TPS Cash Team Blog"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="POSTS" class="nav-list-link">POSTS</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="ARCHIVES" class="nav-list-link">ARCHIVES</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Wiremock - A fallback solution for existing API?</h1><div class="post-info">2019-02-15<p class="visit"><i data-hk-page="current">- </i><span> Views</span></p></div><div class="post-content"><p>WireMock is an HTTP mock server. At its core it is web server that can be primed to serve canned responses to particular requests (stubbing) and that captures incoming requests so that they can be checked later (verification).</p>
<p>It also has an assortment of other useful features including record/playback of interactions with other APIs, injection of faults and delays, simulation of stateful behavior.</p>
<a id="more"></a>
<h2 id="Assumptions"><a href="#Assumptions" class="headerlink" title="Assumptions"></a>Assumptions</h2><p>WireMock can create stub mappings from requests it has received. Combined with its proxying feature this allows you to “record” stub mappings from interaction with existing APIs.</p>
<p>In the real world our API often has many external dependencies and when these dependencies are not available then our API would also stop working.</p>
<p>Regarding above feature of Wiremock, can we use it to record requests and relevant responses of our existing API and replay the results back when there is any outage of our API due to external dependency failures or even when the API itself has issues? So we can treat it as a fallback solution for the existing API?</p>
<p>At least it could serve the purpose seemingly.</p>
<h2 id="Concerns"><a href="#Concerns" class="headerlink" title="Concerns"></a>Concerns</h2><p>After taking a deep look into this feature, I find a few drawbacks with this feature (maybe I shouldn’t call it as drawback as Wiremock is not designed for this purpose by nature):</p>
<ul>
<li><p>If I make same request multiple times it only records the first one not the last one, so I can’t get latest response for the same request when replay it back. There is another function called record as scenarios, which records all responses for the same request pattern, but that’s not what I am looking for.</p>
</li>
<li><p>It couldn’t work as expected when deploying Wiremock to multiple hosts and put them behind a load balancer - every Wirkmock instance will record only a part of the requests made by clients and when replaying the results back one request could hit any Wiremock instance which might not record any response for this request.</p>
</li>
<li><p>Stub mappings resides in memory before I stop the recording and start a new one, so if the recording runs for long time or big volume of requests hit the Wiremock server it could potentially exhaust all memory allocated to the JVM instance.</p>
</li>
<li><p>Stub mappings are written to disk when the recording is stopped which is not safe and cumbersome.</p>
</li>
<li><p>Stub mappings for same request pattern are written to files with different names between different recordings and it leads to uncertain result for same request pattern when replaying the results back.</p>
</li>
<li><p>Performance impact due to memory intensive usage and disk access and also the proxy adds one extra hop in the network.</p>
</li>
</ul>
<h2 id="Solutions"><a href="#Solutions" class="headerlink" title="Solutions"></a>Solutions</h2><p>So how do we make it work if we really want to use it? I had a look at the source code of Wiremock and initial solutions for above items are:</p>
<ul>
<li><p>Wiremock replays the results by reversing the order of the stubs and take the first one (which is the one happened at earliest) for duplicate requests, so I can add a parameter in the RecordSpec to tell Wiremock to not reverse the order so it can take the last one instead of the first one</p>
</li>
<li><p>We can use Wiremock admin API to load all existing stubs from a centralized storage before replaying, which is based on solution for disk access issue too</p>
</li>
<li><p>Use Wiremock API to reset the stubs in memory at a regular interval</p>
</li>
<li><p>Change the naming conversion of the stubs so that there is only one copy for duplicate requests with same request pattern.</p>
</li>
<li><p>Write the stubs into Mongo instead of file system</p>
</li>
</ul>
<h2 id="Questions"><a href="#Questions" class="headerlink" title="Questions"></a>Questions</h2><p>Implementing first 4 items are quite easy but need more efforts on the last one considering concurrent scenarios. The question is do we think it worths the effort and do we have any other better solution for such use case? </p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>Categories</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/TED/">TED</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/framework/">framework</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/home/">home</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/technologies/">technologies</a><span class="category-list-count">49</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>Tag Cloud </h4><a href="/tags/Mac/" style="font-size: 12px;">Mac</a> <a href="/tags/TED/" style="font-size: 10px;">TED</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/annotation/" style="font-size: 10px;">annotation</a> <a href="/tags/api/" style="font-size: 10px;">api</a> <a href="/tags/centos/" style="font-size: 14px;">centos</a> <a href="/tags/cucumber/" style="font-size: 10px;">cucumber</a> <a href="/tags/curl/" style="font-size: 10px;">curl</a> <a href="/tags/database/" style="font-size: 12px;">database</a> <a href="/tags/design/" style="font-size: 10px;">design</a> <a href="/tags/docker/" style="font-size: 12px;">docker</a> <a href="/tags/git/" style="font-size: 18px;">git</a> <a href="/tags/home/" style="font-size: 10px;">home</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jdk/" style="font-size: 14px;">jdk</a> <a href="/tags/jekyll/" style="font-size: 10px;">jekyll</a> <a href="/tags/json/" style="font-size: 10px;">json</a> <a href="/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/tags/life/" style="font-size: 14px;">life</a> <a href="/tags/linux/" style="font-size: 20px;">linux</a> <a href="/tags/lunr/" style="font-size: 10px;">lunr</a> <a href="/tags/mail/" style="font-size: 10px;">mail</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/mysql/" style="font-size: 12px;">mysql</a> <a href="/tags/network/" style="font-size: 10px;">network</a> <a href="/tags/nosql/" style="font-size: 10px;">nosql</a> <a href="/tags/oracle/" style="font-size: 12px;">oracle</a> <a href="/tags/outing/" style="font-size: 10px;">outing</a> <a href="/tags/principles/" style="font-size: 10px;">principles</a> <a href="/tags/project/" style="font-size: 10px;">project</a> <a href="/tags/recipe/" style="font-size: 10px;">recipe</a> <a href="/tags/regex/" style="font-size: 14px;">regex</a> <a href="/tags/restful/" style="font-size: 10px;">restful</a> <a href="/tags/sed/" style="font-size: 10px;">sed</a> <a href="/tags/servlet/" style="font-size: 10px;">servlet</a> <a href="/tags/shell/" style="font-size: 16px;">shell</a> <a href="/tags/sql/" style="font-size: 12px;">sql</a> <a href="/tags/ss/" style="font-size: 10px;">ss</a> <a href="/tags/ssh/" style="font-size: 10px;">ssh</a> <a href="/tags/ssl/" style="font-size: 10px;">ssl</a> <a href="/tags/string/" style="font-size: 10px;">string</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a> <a href="/tags/wiremock/" style="font-size: 10px;">wiremock</a></div></div><div class="widget"><div class="recent"><h4>Recent Posts </h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/02/15/wiremock/">Wiremock - A fallback solution for existing API?</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/25/maven-docker-plugin/">Build Docker Image with Maven</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/23/shuangxi-outing/">Shuangxi Outing</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/ssl-handshake-failure-jdk8/">SSL Handshake Failure after Upgrading to JDK 8</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/29/check-connection-count/">Check DB Connection Count for Processes on Linux</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2017/11/25/maven-docker-plugin/" class="next">NEXT</a></div><div id="disqus_thread"><script type="text/javascript">
var disqus_shortname = 'tpscash';
var disqus_identifier = '2019/02/15/wiremock/';
var disqus_title = 'Wiremock - A fallback solution for existing API?';
var disqus_url = 'http://tpscash.github.io/2019/02/15/wiremock/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div><div class="copyright"><p>© 2016 - 2019 <a target="_blank">Kevin</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p>闽ICP备16007301号-2</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>