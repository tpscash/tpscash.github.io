title: Wiremock - A fallback solution for existing API?
date: 2019-02-15 23:30:00 +0800
categories:
 - technologies
tags:
 - wiremock
author: Kevin
---

WireMock is an HTTP mock server. At its core it is web server that can be primed to serve canned responses to particular requests (stubbing) and that captures incoming requests so that they can be checked later (verification).

It also has an assortment of other useful features including record/playback of interactions with other APIs, injection of faults and delays, simulation of stateful behaviour.

<!-- more -->

## Assumptions

WireMock can create stub mappings from requests it has received. Combined with its proxying feature this allows you to “record” stub mappings from interaction with existing APIs.

In the real world our API often has many external dependencies and when these dependecies are not avaible then our API would also stop working.

Regarding above feature of Wiremock, can we use it to record requests and relevant reponses of our existing API and replay the results back when there is any outgage of our API due to external dependency failures or even when the API iteself has issues? So we can treat it as a fallback solution for the existing API?

At least it could serve the purpose seemingly.

## Concerns

After take a deep look into this features, I find a few drawbacks with the idea (maybe I shouldn't call it as drawback as Wiremock is not designed for this purpose by nature):

* If I make same request mutiple times it only record the first one not the last one, so I can't get latest response for the same request when replay it back. There is another function called record as scenarios, which records all respones for the same request pattern, but that's not what I am looking for.

* It couldn't work as expected when deploying it to multiple host and put them behind a load balancer - every Wirkmock instance will record part of the requests made by client and when replay the results back one request could hit any Wiremock instance which might not record any reponse for this request.

* Stub mappings resides in memeory before I stop the recording and start a new one, so if the recording runs for long time or big volume of requests hit the Wiremock server it could potentically exhaust all memory allocated to the JVM instance.

* Stub mappings are written to disk when the recording is stopped which is not safe and cumbersome

* Performance impact due to memory intense usage and disk access


## Solutions

So how do we make it work if we really want to use it? I had a look at the source code of Wiremock and initial solutions for above items are:

* Wiremock replays the result by reversing the order of the stubs take the first one (which is the one happened at earliest) for duplicate requests, so I can add a parameter in the RecordSpec to tell Wiremock to not reverse the order so it can take the last one instead of the first one

* We can use it Wiremock admin API to load all stubs from a centralized storage for replay, which is based on solution for disk access issue too

* Use Wiremock API to reset the stubs in memory at a regular interval

* Write the stubs into Mogo instead of file system


## Questions

Implementing first 3 items are quite easy but need more efforts on the last one considering concurrent scenarios. The question is do we think it worth the effort and do we have any other better solution for such use case? 